(()=>{"use strict";const e=document.querySelector("#card"),t=(e,t,o)=>{const r=o.querySelector(e);if(""!==t)return t;r.classList.add("hidden")},o={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},r=document.querySelector(".map__filters"),n=r.querySelector("#housing-type"),a=r.querySelector("#housing-price"),s=r.querySelector("#housing-rooms"),c=r.querySelector("#housing-guests"),i=r.querySelector("#housing-features").querySelectorAll("input"),d=e=>{e(_.debounce((()=>m()),500))},l=[];let u=()=>null;const p={typeHouse:()=>!0,price:()=>!0,numberRooms:()=>!0,numberGuests:()=>!0,features:()=>!0},m=()=>{const e=[];for(let t of l){if(10===e.length)break;p.typeHouse(t)&&p.price(t)&&p.numberRooms(t)&&p.numberGuests(t)&&p.features(t)&&e.push(t)}u(e)};d((e=>{n.addEventListener("change",(()=>{"any"===n.value?p.typeHouse=()=>!0:p.typeHouse=e=>n.value===e.offer.type,e()}))})),d((e=>{a.addEventListener("change",(()=>{switch(a.value){case"middle":p.price=e=>e.offer.price>=1e4&&e.offer.price<=5e4;break;case"low":p.price=e=>e.offer.price<1e4;break;case"high":p.price=e=>e.offer.price>5e4;break;default:p.price=()=>!0}e()}))})),d((e=>{s.addEventListener("change",(()=>{"any"===s.value?p.numberRooms=()=>!0:p.numberRooms=e=>e.offer.rooms===+s.value,e()}))})),d((e=>{c.addEventListener("change",(()=>{"any"===c.value?p.numberGuests=()=>!0:p.numberGuests=e=>e.offer.guests===+c.value,e()}))}));const h=[],f=e=>{if(0===h.length)return!0;for(let t of h)if(!e.offer.features.includes(t))return!1;return!0};d((e=>{for(let t of i)t.addEventListener("change",(()=>{if(p.features=f,t.checked)h.push(t.value);else{const e=h.indexOf(t.value);h.splice(e,1)}e()}))}));const y=(e,t)=>{e.classList.add(t);for(let t of e.children)t.setAttribute("disabled","disabled")},v=(e,t)=>{e.classList.remove(t);for(let t of e.children)t.removeAttribute("disabled")},g=document.querySelector(".ad-form"),S=r,b={lat:35.6895,lng:139.69171},q=b,k={size:[40,40],anchor:[20,40],shadowSize:[35,35],shadowAnchor:[10,35]},w={size:[30,30],anchor:[15,30],shadowSize:[30,30],shadowAnchor:[8,30]};y(g,"ad-form--disabled"),y(S,"map__filters--disabled");const E=L.map("map-canvas").on("load",(()=>{v(g,"ad-form--disabled"),v(S,"map__filters--disabled")})).setView(b,10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(E);const x=L.icon({iconUrl:"img/main-pin.svg",iconSize:k.size,iconAnchor:k.anchor,shadowUrl:"leaflet/images/marker-shadow.png",shadowSize:k.shadowSize,shadowAnchor:k.shadowAnchor}),C=L.marker(q,{draggable:!0,icon:x});C.addTo(E);const A=L.icon({iconUrl:"img/pin.svg",iconSize:w.size,iconAnchor:w.anchor,shadowUrl:"leaflet/images/marker-shadow.png",shadowSize:w.shadowSize,shadowAnchor:w.shadowAnchor}),z=[],V=r=>{z.forEach((e=>{e.remove()})),z.length=0,r.forEach((r=>{const n=L.marker({lat:r.location.lat,lng:r.location.lng},{icon:A});n.addTo(E).bindPopup((r=>{const n=e.content.cloneNode(!0);var a;n.querySelector(".popup__avatar").setAttribute("src",r.author.avatar),n.querySelector(".popup__title").textContent=t(".popup__title",r.offer.title,n),n.querySelector(".popup__text--address").textContent=t(".popup__text--address",r.offer.address,n),n.querySelector(".price").textContent=t(".popup__text--price",r.offer.price,n),n.querySelector(".popup__type").textContent=o[r.offer.type],n.querySelector(".popup__text--capacity").textContent=((a=t(".popup__text--capacity",r.offer.rooms,n))%10==1&&11!==a?a+" комната":a%10>=5||a%10==0||11===a?a+" комнат":a+" комнаты")+" для "+(e=>e%10==1&&11!==e?e+" гостя":e+" гостей")(t(".popup__text--capacity",r.offer.guests,n)),n.querySelector(".popup__text--time").textContent="Заезд после "+t(".popup__text--time",r.offer.checkin,n)+", выезд до "+t(".popup__text--time",r.offer.checkout,n),n.querySelector(".popup__description").textContent=t(".popup__description",r.offer.description,n),((e,t)=>{const o=t.querySelector(".popup__photos"),r=t.querySelector(".popup__photo");o.removeChild(r),e.forEach(((t,n)=>{const a=r.cloneNode();a.src=e[n],o.appendChild(a)}))})(r.offer.photos,n),n.querySelectorAll(".popup__feature").forEach((e=>{e.style.display="none"})),r.offer.features.forEach((e=>{n.querySelector(`.popup__feature--${e}`).style.display="inline-block"}));const s=document.createElement("div");return s.appendChild(n),s.innerHTML})(r),{keepInView:!0}),z.push(n)}))},T=["jpg","jpeg","png"],H=document.querySelector("#avatar"),$=document.querySelector(".ad-form-header__preview"),D=$.children[0].src,F=document.querySelector("#images"),R=document.querySelector(".ad-form__photo"),j=(e,t,o)=>{e.addEventListener("change",(()=>{const r=e.files[0],n=r.name.toLowerCase(),a=T.some((e=>n.endsWith(e)));if(!t.hasChildNodes()){const e=document.createElement("img");e.style.width="100%",e.style.height="100%",e.alt=o,t.append(e)}if(a){const e=new FileReader;e.addEventListener("load",(()=>{t.children[0].src=e.result})),e.readAsDataURL(r)}}))};j(H,$),j(F,R,"Фотография жилья");const N={bungalow:0,flat:1e3,house:5e3,palace:1e4},U=1e6,G=100,M=document.querySelector(".ad-form"),O=M.querySelector("#type"),P=M.querySelector("#price"),I=M.querySelector("#title"),W=M.querySelector(".ad-form__element--time").querySelectorAll("select");I.addEventListener("input",(()=>{I.min=30,I.max=100;const e=I.value.length;e<30?I.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?I.setCustomValidity("Удалите лишние "+(e-100)+" симв."):I.setCustomValidity(""),I.reportValidity()})),O.addEventListener("change",(()=>{P.placeholder=N[O.value],P.min=N[O.value],P.max=U})),P.addEventListener("input",(()=>{P.placeholder=N[O.value],P.min=N[O.value],P.max=U})),W[0].addEventListener("click",(()=>{W[1].value=W[0].value})),W[1].addEventListener("click",(()=>{W[0].value=W[1].value}));const B=M.querySelector("#room_number"),J=M.querySelector("#capacity");B.addEventListener("click",(()=>{const e=+B.value,t=+J.value;e>=G&&t>0?J.setCustomValidity("Измените количество гостей или комнат"):e<G&&0===t?J.setCustomValidity("Выберите количество гостей"):e<t&&t<G?J.setCustomValidity("Измените количество гостей или комнат"):J.setCustomValidity("")})),J.addEventListener("click",(()=>{const e=+B.value,t=+J.value;(e<G&&t>0&&e>=t||e>=G&&0===t)&&J.setCustomValidity(""),e>=G&&t>0?J.setCustomValidity("Измените количество гостей или комнат"):e<G&&0===t?J.setCustomValidity("Выберите количество гостей или комнат"):e<t&&t<G&&J.setCustomValidity("Измените количество гостей или комнат")}));const K=document.querySelector(".ad-form__reset"),Q=M.querySelector("#address");Q.setAttribute("readonly","readonly");const X=C.getLatLng(),Y=`${X.lat.toFixed(5)}, ${X.lng.toFixed(5)}`;Q.value=Y,C.on("drag",(e=>{Q.value=`${e.target.getLatLng().lat.toFixed(5)}, ${e.target.getLatLng().lng.toFixed(5)}`}));const Z=()=>{M.reset(),(()=>{r.reset();for(let e in p)p[e]=()=>!0;m()})(),Q.value=Y,C.setLatLng(X),R.innerHTML="",$.children[0].src=D};K.addEventListener("click",(e=>{e.preventDefault(),Z()}));const ee=document.querySelector("main"),te=e=>"Escape"===e.key||"Esc"===e.key;var oe,re;oe=e=>{((e,t)=>{l.push(...e),u=t,m()})(e,V)},fetch("https://22.javascript.pages.academy/keksobooking/data").then((e=>e.json())).then((e=>{oe(e)})).catch((()=>{((e,t,o)=>{const r=(e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstChild})(`<div style = "z-index: 400; position: absolute; width: ${t};\n  padding: 10px 3px; font-size: 30px; text-align: center;\n  background-color: lightblue;">${o}</div>`);document.querySelector(e).append(r),setTimeout((()=>{r.remove()}),5e3)})(".map__canvas","100%","К сожалению, сервер не отвечает. Обновите страницу."),y(r,"map__filters--disabled")})),re=()=>{const e=document.querySelector("#error").content.cloneNode(!0),t=document.createElement("div");t.appendChild(e),ee.appendChild(t);const o=document.querySelector(".error__button"),r=e=>{te(e)&&(e.preventDefault(),n())},n=()=>{t.classList.add("hidden"),document.removeEventListener("keydown",r)};o.addEventListener("click",(()=>{n()})),document.addEventListener("keydown",r),t.addEventListener("click",(()=>{n()}))},M.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(e.target);fetch("https://22.javascript.pages.academy/keksobooking",{method:"POST",body:t}).then((e=>{e.ok?(()=>{const e=document.querySelector("#success").content.cloneNode(!0),t=document.createElement("div");t.appendChild(e),ee.appendChild(t);const o=e=>{te(e)&&(e.preventDefault(),r())},r=()=>{Z(),t.classList.add("hidden"),document.removeEventListener("keydown",o)};document.addEventListener("keydown",o),t.addEventListener("click",(()=>{r()}))})():re()})).catch((()=>{re()}))}))})();
//# sourceMappingURL=main.bundle.js.map